
<!DOCTYPE html>
<html lang="en">

    <head>

        <meta charset="utf-8" />
        <title>Implementierungsleitfaden ISiK-Sicherheit - Rechtedelegation und Client-Authentifizierung</title>

        <link rel="icon" href="static/styles/common/favicon.ico" />

        <script src="static/styles/common/jquery/jquery.min.js"></script>
        <script src="static/styles/common/bootstrap/bootstrap.min.js"></script>

        <link rel="stylesheet" href="static/styles/common/main.min.css" />
        <link rel="stylesheet" href="static/styles/common/bootstrap/bootstrap.min.css" />
        <link rel="stylesheet" href="static/styles/common/rendering/rendering.min.css" />

        <script src="static/styles/common/rendering/stu3TreeTable.min.js"></script>
        <script src="static/styles/common/rendering/baseTreetable.min.js"></script>

        <link rel="stylesheet" href="static/styles/twolevelmenu/style.css?v=1d9a8dca3e36700" />

    </head>

    <body>

        <div id="ig-viewer">

            <div class="ig-view-content">

                <div id="ig-view-twolevelmenu">

                    <div class="header" role="banner" aria-label="Header">
                        


<nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="ImplementationGuide-markdown-Einfuehrung.html">
                Implementierungsleitfaden ISiK-Sicherheit - Rechtedelegation und Client-Authentifizierung
            </a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">


                    <li>
                        <a href="ImplementationGuide-markdown-Einfuehrung.html">
                            Einf&#xFC;hrung
                        </a>
                    </li>

                        <li>
                            <a href="ImplementationGuide-markdown-ReleaseNotes.html">
                                Release Notes
                            </a>
                        </li>
                        <li>
                            <a href="ImplementationGuide-markdown-Motivation.html">
                                Motivation
                            </a>
                        </li>
                        <li class="dropdown">

                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                &#xDC;bergreifende Festlegungen <span class="caret"></span>
                            </a>

                            <ul class="dropdown-menu">

                                    <li>
                                        <a href="ImplementationGuide-markdown-UebergreifendeFestlegungen.html">
                                            &#xDC;bergreifende Festlegungen
                                        </a>
                                    </li>
                                    <li role="separator" class="divider"></li>

                                    <li>
                                        <a href="ImplementationGuide-markdown-Methodik.html">
                                            Methodik
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-BestaetigungsrelevanteSysteme.html">
                                            Best&#xE4;tigungsrelevante Systeme
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-KompatibilitaetDerGematikSpezifikation.html">
                                            Kompatibilit&#xE4;t der gematik-Spezifikation
                                        </a>
                                    </li>

                            </ul>
                        </li>
                        <li class="dropdown">

                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                &#xDC;bersicht <span class="caret"></span>
                            </a>

                            <ul class="dropdown-menu">

                                    <li>
                                        <a href="ImplementationGuide-markdown-Uebersicht.html">
                                            &#xDC;bersicht
                                        </a>
                                    </li>
                                    <li role="separator" class="divider"></li>

                                    <li>
                                        <a href="ImplementationGuide-markdown-ISiKAutorisierung.html">
                                            ISiK-Sicherheit: Autorisierung
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-ISiKundSMART.html">
                                            SMART on FHIR
                                        </a>
                                    </li>

                            </ul>
                        </li>
                        <li class="dropdown">

                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                ISiK-Konformit&#xE4;t <span class="caret"></span>
                            </a>

                            <ul class="dropdown-menu">

                                    <li>
                                        <a href="ImplementationGuide-markdown-Conformance.html">
                                            ISiK-Konformit&#xE4;t
                                        </a>
                                    </li>
                                    <li role="separator" class="divider"></li>

                                    <li>
                                        <a href="ImplementationGuide-markdown-ConformanceSmartCapabilities.html">
                                            SMART Capabilities
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-ConformanceScopesKontexte.html">
                                            Scopes und Compartments
                                        </a>
                                    </li>

                            </ul>
                        </li>

            </ul>
        </div>
    </div>
</nav>

                    </div>

                    <div class="content container" role="main" aria-label="Main content">
                        

    <div class="row">

            <div class="col-md-6">
                <ul class="nav nav-pills nav-stacked affix-top">
                        <li>
                            <a title="Schritt 1 - Registrierung Client" href="#ImplementationGuide-markdown-Schritt1RegistrierungClient">Schritt 1 - Registrierung Client</a>
                        </li>
                        <li>
                            <a title="Schritt 2 - Client Autorisierung" href="#ImplementationGuide-markdown-Schritt2ClientAutorisierung">Schritt 2 - Client Autorisierung</a>
                        </li>
                        <li>
                            <a title="Schritt 3 - Evaluierung Autorisierungsanfrage" href="#ImplementationGuide-markdown-Schritt3EvaluierungAutorisierungsanfragen">Schritt 3 - Evaluierung Autorisierungsanfrage</a>
                        </li>
                        <li>
                            <a title="Schritt 4 - Austausch - Autorisierungscodes Zugangstoken" href="#markdown-Schritt4AustauschAutorisierungscodesZugangstoken">Schritt 4 - Austausch - Autorisierungscodes Zugangstoken</a>
                        </li>
                        <li>
                            <a title="Schritt 5 - FHIR Restful Interaktion" href="#ImplementationGuide-markdown-Schritt5FHIRRestInteraktion">Schritt 5 - FHIR Restful Interaktion</a>
                        </li>
                        <li>
                            <a title="Schritt 6 - Refresh Token &amp; Revocation" href="#ImplementationGuide-markdown-Schritt6RefreshToken">Schritt 6 - Refresh Token &amp; Revocation</a>
                        </li>
                </ul>
            </div>

        <div class="col-md-18">

            <div id="preview-content">

                <h1 id="isik-sicherheit-und-smart-on-fhir">ISiK Sicherheit und SMART on FHIR</h1>
<hr />
<h3 id="informativ">Informativ</h3>
<hr />
<p>ISiK-Sicherheit setzt auf dem HL7-Standard <em>SMART on FHIR</em> auf, der u. a. das Zusammenspiel der Standards FHIR und OAuth2 für die Weitergabe von Zugriffskontexten zum sicheren Zugriff auf FHIR-Ressourcen beschreibt. Wie in der <a href="Motivation.md">Motivation</a> beschrieben, umfassen die normativen Vorgaben von ISiK-Sicherheit jedoch nur eine Untermenge des SMART-on-FHIR-API.</p>
<p>Ergänzend zu den normativen Abschnitten <a href="ISiKAutorisierung.md">ISiK-Sicherheit: Autorisierung</a> und <a href="Conformance.md">ISiK-Konformität</a> wird in diesem und den untergeordneten Abschnittem skizziert, wie eine vollständige Umsetzung des SMART-on-FHIR-Standards im Kontext von ISiK aussehen kann. <strong>Dieser Abschnitt ist informativ, d. h. in ISiK Stufe 3 nicht Gegenstand des Konformitätsfeststellungsverfahrens.</strong></p>
<h2 id="smart-app-launch"><em>SMART App Launch</em></h2>
<p>Die auf den nachgeordneten Seiten beschriebene Implementierungsleitfaden dient zur Erläuterung des Ablaufs eines <em>Smart App Launch</em> (siehe <a href="Uebersicht.md">Übersicht</a>). Ziel des <em>Smart App Launch</em> ist es, ein Zugangstoken von einem OAuth2-kompatiblen Autorisierungsserver zu erhalten, mittels dessen eine FHIR RESTful API-Interaktion durchgeführt werden kann. Dies erfolgt unter Berücksichtigung der Zugriffsrechte der Benutzer in dem den <em>SMART App Launch</em> auslösenden System (KIS, Portal), das im Folgenden analog zur SMART-on-FHIR-Spezifikation als 'EHR' (<em>Electronic Health Record</em>) bezeichnet wird.</p>
<p>Um ein Zugangstoken für den Zugriff auf einen Ressourcenserver zu erhalten, sind folgende sechs Schritte notwendig, die auf den Unterseiten zu dieser Seite jeweils im Detail beschrieben sind:</p>
<ul>
<li>Registrierung eines <em>SMART Clients</em> mit dem EHR</li>
<li>Der <em>SMART Client</em> fragt den Autorisierungsserver des EHR um Autorisierung an</li>
<li>Der EHR evaluiert die Autorisierungsanfrage und initiiert ggf, die Authentifizierung des (menschlichen) Nutzers</li>
<li>Austausch des vom EHR an den Client ausgegebenen Autorisierungscodes gegen ein Zugangstoken.</li>
<li>Ausführung einer durch das Zugangstoken abgesicherten FHIR Restful Interaktion am Ressourcenserver</li>
<li>Ausstellung eines &quot;Refresh&quot;-Zugangstoken.</li>
</ul>
<p>Eine Übersicht des zusammenhängenden <em>SMART App Launch</em> ist dem Abschnitt <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#smart-authorization--fhir-access-overview">SMART App Launch - 2.0.3 - SMART authorization &amp; FHIR access: overview</a> der SMART-on-FHIR-Spezifikation zu entnehmen.</p>


                        <div id="ImplementationGuide-markdown-Schritt1RegistrierungClient">
                            <h1 id="schritt-1-registrierung-eines-smart-clients-mit-dem-ehr">Schritt 1: Registrierung eines SMART Clients mit dem EHR</h1>
<hr />
<h3 id="informativ">Informativ</h3>
<hr />
<p>Bevor ein Client eine EHR Launch Sequence oder Standalone Launch Sequence ausführen kann, muss der Client beim Autorisierungsserver des EHR registriert werden. Per Abschnitt <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#step-1-register">SMART App Launch - 2.0.5 - Register App with EHR</a> ist ihm freigestellt, wie diese Registrierung durchgeführt wird.</p>
<p>Der Autorisierungsserver muss die <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#request">Anforderungen an die Registrierung von Launch Urls und Redirect Uris - SMART App Launch - 2.0.5.1 - Request</a> unterstützen. Es wird besonders auf die Anforderungen aus RFC8252 - Abschnitt <a href="https://datatracker.ietf.org/doc/html/rfc8252#section-7">7.  Receiving the Authorization Response in a Native App</a> hingewiesen. Für Redirect Uris sind folgende Schemata zu unterstützen:</p>
<ul>
<li>Private-Use URI Scheme Redirection</li>
<li>Claimed &quot;https&quot; Scheme URI Redirection</li>
<li>Loopback Interface Redirection</li>
</ul>
<p>Durch die zuvor genannten Ausnahmen ergibt sich das Erfordernis, dass bei der Validierung der Redirect Urls (während Schritt 3 - &quot;Bestätigungsrelevantes System evaluiert die Autorisierungsanfrage, Authentifizierung der Endnutzer&quot;) nicht davon ausgegangen werden kann, dass diese einen statischen Wert besitzen.</p>
<p>Der Autorisierungsserver vergibt auf Basis der Registrierung eine Client-Id, welche zur eineindeutigen Identifizierung des Clients dient. Diese Client-Id MUSS während der Authentifizierung des Clients bei einer Access-Token-Anfrage (siehe Schritt 4 - Austausch des Autorisierungscodes für ein Zugangstoken) verwendet werden.</p>
<p>Die Verwendung von <a href="https://datatracker.ietf.org/doc/html/rfc7591">RFC7591 - OAuth 2.0 Dynamic Client Registration Protocol</a> wird ausdrücklich empfohlen. Es wird hier die Verwendung des <a href="https://datatracker.ietf.org/doc/html/rfc7591#appendix-A.1.2">Protected Dynamic Client Registration Prozesses</a> empfohlen, um ein unkontrolliertes Registrieren von Clients zu verhindern. Es ist zu beachten, dass derzeitig keine standardisierte Metadata Extension für die Registrierung der Launch Urls existiert. Diese kann beliebig gewählt werden.</p>
<hr />
<h2 id="beispiel">Beispiel</h2>
<p>Folgender Request stellt beispielhaft dar, welche Parameter bei einer Anfrage an einen Dynamic-Client-Registration-Endpunkt vorhanden sein können:</p>
<p>POST /register HTTP/1.1<br>
Content-Type: application/json<br>
Accept: application/json<br>
Host: server.example.com<br></p>
<div class="lang-json editor-colors"><div style="color:Black;background-color:White;"><pre>
{
    <span style="color:#A31515;">&quot;redirect_uris&quot;</span>: [<span style="color:#A31515;">&quot;https://example.org/redirect_uri/fhir/client/exampleId/&quot;</span>],
    <span style="color:#A31515;">&quot;token_endpoint_auth_method&quot;</span>: [<span style="color:#A31515;">&quot;client_secret_basic&quot;</span>, <span style="color:#A31515;">&quot;client_secret_post&quot;</span>, <span style="color:#A31515;">&quot;private_key_jwt&quot;</span>],
    <span style="color:#A31515;">&quot;grant_types&quot;</span>: [<span style="color:#A31515;">&quot;authorization_code&quot;</span>, <span style="color:#A31515;">&quot;refresh_token&quot;</span>],
    <span style="color:#A31515;">&quot;response_types&quot;</span>: [<span style="color:#A31515;">&quot;code&quot;</span>],
    <span style="color:#A31515;">&quot;client_name&quot;</span>: <span style="color:#A31515;">&quot;MyFhirClientName&quot;</span>,
    <span style="color:#A31515;">&quot;jwks_uri&quot;</span>: <span style="color:#A31515;">&quot;https://example.org/jwks/fhir/client/exampleId/jwks.json&quot;</span>
}

</pre></div>
</div>
<p>Response:</p>
<p>HTTP/1.1 201 Created<br>
Content-Type: application/json<br>
Cache-Control: no-store<br>
Pragma: no-cache<br></p>
<div class="lang-json editor-colors"><div style="color:Black;background-color:White;"><pre>
{
    <span style="color:#A31515;">&quot;client_id&quot;</span>: <span style="color:#A31515;">&quot;TestClientId&quot;</span>,
    <span style="color:#A31515;">&quot;redirect_uris&quot;</span>: [<span style="color:#A31515;">&quot;https://example.org/redirect_uri/fhir/client/exampleId&quot;</span>],
    <span style="color:#A31515;">&quot;token_endpoint_auth_method&quot;</span>: [<span style="color:#A31515;">&quot;client_secret_basic&quot;</span>, <span style="color:#A31515;">&quot;client_secret_post&quot;</span>, <span style="color:#A31515;">&quot;private_key_jwt&quot;</span>],
    <span style="color:#A31515;">&quot;grant_types&quot;</span>: [<span style="color:#A31515;">&quot;authorization_code&quot;</span>, <span style="color:#A31515;">&quot;refresh_token&quot;</span>],
    <span style="color:#A31515;">&quot;response_types&quot;</span>: [<span style="color:#A31515;">&quot;code&quot;</span>],
    <span style="color:#A31515;">&quot;client_name&quot;</span>: <span style="color:#A31515;">&quot;MyFhirClientName&quot;</span>,
    <span style="color:#A31515;">&quot;jwks_uri&quot;</span>: <span style="color:#A31515;">&quot;https://example.org/jwks/fhir/client/exampleId/jwks.json&quot;</span>
}

</pre></div>
</div>

                        </div>
                        <div id="ImplementationGuide-markdown-Schritt2ClientAutorisierung">
                            <h1 id="schritt-2-app-bittet-um-autorisierung">Schritt 2: App bittet um Autorisierung</h1>
<hr />
<h3 id="informativ">Informativ</h3>
<hr />
<p>Im nachfolgenden Schritt wird durch den Client an dem &quot;authorize&quot;-Endpunkt des Autorisierungsservers ein Autorisierungscode angefragt, welcher innerhalb eines Authorization Code Flows (vgl. <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-4.1">RFC6749</a>) durch ein OAuth 2.0 Access Token ersetzt werden kann.</p>
<p>Abhängig davon, ob der Client durch einen <em>EHR Launch</em> oder <em>Standalone Launch</em> (siehe <a href="ISiKAutorisierung.md">'ISiK-Sicherheit: Autorisierung'</a>) gestartet wird, existieren unterschiedliche Schritte für die Anfrage eines Autorisierungscodes.</p>
<hr />
<h2 id="ehr-launch">EHR Launch</h2>
<p>Der EHR (KIS, Portal, etc.) muss in der Lage sein, den Client durch einen externen Kontextaufruf zu starten. Im Kontext der derzeitig eingeloggten Benutzer:in wird der Client gestartet, vgl. <div class='error'>Command 'pagelink' could not render: Page not found.</div>. Der Aufruf des Clients muss alle in <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#step-2-launch-ehr">SMART App Launch - 2.0.7 - Launch App: EHR Launch</a> dokumentierten Parameter enthalten.</p>
<p>Es sei darauf hingewiesen, dass jeder EHR Launch mit einem eindeutigen Launch Parameter zu assoziieren ist. Mit diesem beliebig gewählten Parameter (z.B. eine UUID) kann der Client das Access Token mit dem Kontext, aus dem der Client gestartet worden ist, verknüpfen. Der Kontext kann beispielsweise Informationen zum Patienten oder Kontakt/Fall enthalten, welcher dem Anwender zuvor präsentiert wurde. Dieser Kontext wird dem Client durch sogenannte <a href="https://hl7.org/fhir/smart-app-launch/STU2/scopes-and-launch-context.html#scopes-for-requesting-context-data">Launch Context Claims</a> vermittelt. Diese Claims enthalten IDs der FHIR-Ressourcen, welche die zuvor genannten Datenobjekte repräsentieren. Es ist notwendig innerhalb der SMART authorization sequence die angeforderten <a href="https://hl7.org/fhir/smart-app-launch/STU2/scopes-and-launch-context.html#scopes-for-requesting-context-data">Launch Context Claims</a> an den Client zurückzugeben, vgl. Abschnitt <a href="ImplementationGuide-markdown-Schritt4AustauschAutorisierungscodesZugangstoken.html" title='ImplementationGuide/markdown/Schritt4AustauschAutorisierungscodesZugangstoken.md'>Austausch des Autorisierungscodes für ein Zugangstoken</a>. Der Client kann spezifische Kontextparameter anfragen. Sollten diese jedoch nicht verfügbar sein (z.B. der Client wurde ohne Patientenkontext aufgerufen), können die zurückgegebenen Launch Context Claims von den gewünschten Scopes abweichen.</p>
<hr />
<h2 id="standalone-launch-sequence">Standalone Launch Sequence</h2>
<p>Aufgrund des fehlenden Kontexts zwischen Client und dem System, kann der Client durch Angabe von gewünschten Smart Launch Scopes bestimmen, welche Details durch den Autorisierungsserver in der Access Token Response bereitgestellt werden müssen. Beispielsweise kann, äquivalent zum EHR Launch, der Patienten- und/oder Kontakt/Fall-Kontext angefordert werden. Die Kodierung der Scopes ist im normativen Teil von ISiK-Sicherheit auf der Seite <a href="ConformanceScopesKontexte.md">'Scopes und Kontexte'</a> beschrieben.</p>
<hr />
<h2 id="parameter-autorisierungsanfrage">Parameter Autorisierungsanfrage</h2>
<p>Der Aufruf des Clients muss alle in <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#step-4-authorization-code">SMART App Launch - 2.0.9 - Obtain authorization code</a> dokumentierten Parameter enthalten. Insbesondere gilt dies für die Unterstützung von HTTP POST-basierten Autorisierungsanfragen und der Unterstützung von <a href="https://datatracker.ietf.org/doc/html/rfc7636">Proof Key for Code Exchange by OAuth Public Clients</a>.</p>
<p>Zu beachten ist, dass durch den SMART App Launch der &quot;state&quot;-Parameter abweichend von RFC6749 verpflichtend ist.</p>
<hr />
<h2 id="tls">TLS</h2>
<p>Alle Autorisierungsendpunkte müssen per HTTPS (TLS-Verschlüsselung) erreichbar sein. Im Echtbetrieb muss die Kommunikation ausschließlich per HTTPS erfolgen. Vorgaben zur einzusetzenden TLS Version, siehe <a href="https://simplifier.net/guide/implementierungsleitfadenisik-basismodul/I-markdown-UebergreifendeFestlegungen-UebergreifendeFestlegungen-Rest?version=current">Sicherheitsaspekte</a>.</p>
<hr />
<h2 id="abruf-smart-configuration">Abruf SMART Configuration</h2>
<p>Als Einstiegspunkt für einen Standalone Launch muss dem Client die Url des FHIR Endpunktes bekannt gegeben werden. Anschließend erfolgt eine Abfrage des &quot;.well-known/smart-configuration&quot; Dokumentes, welche durch den FHIR Endpunkt bereitgestellt werden muss. Vorgaben zum Format sind dem Abschnitt <a href="ImplementationGuide-markdown-ConformanceSmartCapabilities.html" title='ImplementationGuide/markdown/ConformanceSmartCapabilities.md'>SMART Capabilities</a> zu entnehmen. Hierdurch erhält der Client dynamisch die Adresse des Autorisierungsservers inkl. &quot;authorize&quot; und &quot;token&quot; Endpunkt. Falls durch das bestätigungsrelevante System OAuth 2.0 Endpunkte optional über das CapabilityStatement des FHIR-Endpunktes zur Verfügung gestellt werden, müssen diese Inhalte identisch zu den Inhalten des &quot;.well-known/smart-configuration&quot; Dokumentes sein.</p>
<hr />
<h2 id="hinweise-zu-identity-scopes">Hinweise zu Identity Scopes</h2>
<p>Um Informationen über die authentifizierten Endbenutzer:in zu erhalten, kann ein Client per OpenID Connect ein Identitätstoken zusammen mit einem Zugangstoken anfragen. Hierzu sind in Kombination die Scopes &quot;openid&quot; und &quot;fhirUser&quot; zu verwenden. EHR müssen die Vorgaben nach <a href="https://hl7.org/fhir/smart-app-launch/STU2/scopes-and-launch-context.html#scopes-for-requesting-identity-data">2.0.4 - Scopes for requesting identity data</a> umsetzen. Anstatt dem Claim &quot;fhirUser&quot; kann - aus Gründen der Rückwärtskompatibilität - auch der Claim &quot;profile&quot; verwendet werden.</p>
<hr />
<h2 id="hinweise-zu-access-scopes">Hinweise zu Access Scopes</h2>
<p>Innerhalb des Scope Parameters, welcher als Teil der Autorisierungsanfrage versendet wird, kann der Client dem Server mitteilen, welche Scopes zur korrekten Ausführung notwendig sind, d.h. welche FHIR-Restful Interaktionen vom Client benötigt werden. Diese Scopes repräsentieren die Menge aller Scopes, welche durch den Client gewünscht werden, jedoch nicht notwendigerweise durch den Server unterstüzt und/oder erlaubt werden. Es steht dem Autorisierungsserver frei diese Scopes einzuschränken, falls der Client für die Anforderung der Scopes nicht berechtigt ist. Weitere Details zur Syntax der Access Scopes siehe <a href="ConformanceScopesKontexte.md">'Scopes und Kontexte'</a>.</p>
<p>Hieraus folgt, dass die angeforderten Scopes nur die Kategorien an Rechten repräsentieren, die an den anfragenden Client delegiert werden dürfen. Somit können generell bestimmte Rechte ausgeschlossen werden. Eine Anfrage an den FHIR-REST-API-Endpunkt kann jedoch trotz validem Token mit den spezifizierten Scopes abgelehnt werden, falls während der Evaluierung der Anfrage seitens des Servers festgestellt wird, dass der Benutzer die gewünschten Ressourcen nicht verarbeiten darf.</p>
<p>Der Autorisierungsserver muss eine Konfiguration der erlaubten Scopes pro Client unterstützen.</p>
<hr />
<h2 id="beispiel">Beispiel</h2>
<p>POST /authorize HTTP/1.1<br>
Content-Type: application/x-www-form-urlencoded<br>
Host: server.example.com</p>
<pre><code>response_type=code&amp;
client_id=TestClientId&amp;
redirect_uri=https://example.org/redirect_uri/fhir/client/exampleId&amp;iss_idp
scope=user/*.rs openid fhirUser&amp;
state=df01f5f8-5bf2-45ea-ab7a-706361da0515&amp;
aud=http://example.org/fhir/&amp;
code_challenge=2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b&amp;
code_challenge_method=S256
</code></pre>

                        </div>
                        <div id="ImplementationGuide-markdown-Schritt3EvaluierungAutorisierungsanfragen">
                            <h1 id="schritt-3-ehr-evaluiert-die-autorisierungsanfrage-authentifizierung-der-endnutzer">Schritt 3: EHR evaluiert die Autorisierungsanfrage, Authentifizierung der Endnutzer</h1>
<hr />
<h3 id="informativ">Informativ</h3>
<hr />
<p>Um die Entscheidung zu treffen, ob eine Autorisierungsanfrage eines Clients zu akzeptieren oder abzulehnen ist, kann der Autorisierungsserver eine Authentifizierung der Benutzer verlangen.
Sowohl die Smart App Launch Spezifikation, als auch der vorliegende Implementierungsleitfaden, legen keine Vorgaben diesbezüglich fest. Es ist darauf zu achten, dass bei einer fehlgeschlagenen Authentifizierung dem Endnutzer ein eindeutiger Fehlerhinweis angezeigt wird. Ein Redirect zum Client mit einem entsprechenden Fehlercode ist optional.</p>
<p>Im Falle einer erfolgreichen Authentifizierung, muss der Autorisierungsserver die Parameter, welche unter <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#step-4-authorization-code">SMART App Launch - 2.0.9 - Obtain authorization code</a> dokumentiert sind, an den Client zurückliefern. Die Hinweise zur Gültigkeitsdauer des Autorisierungscodes müssen eingehalten werden.</p>
<p>Als Ergebnis dieses Schritts erhält der Client einen einmalig gültigen Autorisierungscode, welcher im weiteren Verlauf gegen ein Autorisierungstoken getauscht werden kann.</p>
<h2 id="hinweise-zu-sektoralen-idps-der-gematik">Hinweise zu Sektoralen IDPs der Gematik</h2>
<p>Perspektivisch sollen für die Authentisierung von Patienten in Krankenhäusern die <a href="https://fachportal.gematik.de/hersteller-anbieter/komponenten-dienste/identity-provider-idp"><em>Sektoralen IDPs</em></a> der Gematik unterstützt werden. Diese basieren wie das Modul ISiK-Sicherheit auf den Standards OAuth2 und OpenID  Connect. Wie in der Übersicht des Moduls ISiK-Sicherheit dargestellt, werden in dieser Spezifikation keine Vorgaben bezüglich der einzusetzenden Authentisierungsdienste getroffen. Eine Unterstützung der Sektoralen IDPs ist perspektivisch jedoch unerlässlich. Um dieses herstellen zu können, muss der Autorisierungsserver einen im https-Aufruf enthaltenen Parameter <em>ISS_IDP</em> unverändert an den Authentifizierungsdienst ('innerer Flow' im Sinne der genannten gematik-Spezifikation) weitergeben. In diesem Parameter wird definiert, welcher Authorisierungsdienst anzusprechen ist.</p>
<hr />
<h2 id="beispiel">Beispiel</h2>
<p>Response:</p>
<pre><code>Location: 
https://example.org/redirect_uri/fhir/client/exampleId?
code=123abc&amp;
state=df01f5f8-5bf2-45ea-ab7a-706361da0515
</code></pre>

                        </div>
                        <div id="markdown-Schritt4AustauschAutorisierungscodesZugangstoken">
                            <h1 id="schritt-4-austausch-des-autorisierungscodes-fur-ein-zugangstoken">Schritt 4: Austausch des Autorisierungscodes für ein Zugangstoken</h1>
<hr />
<h3 id="informativ">Informativ</h3>
<hr />
<p>Sowohl für Public als auch Confidential Clients erfolgt durch den SMART App Launch ein Authorization Code Flow. Dieser Ablauf wird verwendet, um die in <a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics-09#section-2.1.2">Implicit Grant - OAuth 2.0 Security Best Current Practice</a> dokumentierten Sicherheitsrisiken zu minimieren. Im folgenden Schritt wird somit mittels einer vom Client initiierten Anfrage der Authorization Code durch ein Access Token ausgetauscht.</p>
<hr />
<h2 id="authentifizierung-der-clients">Authentifizierung der Clients</h2>
<p>Confidential Clients müssen sich gegenüber dem &quot;Token&quot;-Endpunkt des Autorisierungsservers authentifizieren. Hierfür MÜSSEN folgende Möglichkeiten unterstützt werden:</p>
<h3 id="json-web-token-jwt-profile-for-oauth-2.0-client-authentication-and-authorization-grants-empfehlung">JSON Web Token (JWT) Profile for OAuth 2.0 Client Authentication and Authorization Grants (Empfehlung)</h3>
<p>Die präferierte Variante für die Authentifizierung des Clients erfolgt per <a href="https://datatracker.ietf.org/doc/html/rfc7523">RFC 7523 - JSON Web Token (JWT) Profile for OAuth 2.0 Client Authentication and Authorization Grants</a>. Hierzu müs sen folgende Schritte untersützt werden:</p>
<ol>
<li>Der Client generiert ein Private/Public Key Pair. Hierzu kann entweder <a href="https://datatracker.ietf.org/doc/html/rfc8017">RSA (vgl. RFC8017 - PKCS #1: RSA Cryptography Specifications Version 2.2)</a> oder <a href="https://datatracker.ietf.org/doc/html/rfc6979">ECDSA (vgl. RFC6979 - Deterministic Usage of the Digital Signature Algorithm (DSA) and Elliptic Curve Digital Signature Algorithm (ECDSA))</a> als Algorithmus verwendet werden. Der öffentliche Schlüsselteil wird dem Autorisierungsserver als <a href="https://datatracker.ietf.org/doc/html/rfc7517">JSON Web Key</a> eingebettet in einem <a href="https://datatracker.ietf.org/doc/html/rfc7517#section-5">JSON Web Key Set</a> übermittelt. Angaben zur Schlüssellänge sind den Abschnitten <a href="https://datatracker.ietf.org/doc/html/rfc7518#section-3.3">RFC7518 - Abschnitt 3.3 - Digital Signature with RSASSA-PKCS1-v1_</a> und <a href="https://datatracker.ietf.org/doc/html/rfc7518#section-3.4">RFC7518 - Abschnitt 3.4 - Digital Signature with ECDSA</a> zu entnehmen.</li>
</ol>
<p>Folgende Anforderungen werden an den JSON Web Key gestellt:</p>
<ul>
<li><p>Als Signaturalgorithmus muss durch den Autorisierungsserver mindestens RS256, ES256, RS384, sowie ES384 akzeptiert werden, <a href="https://datatracker.ietf.org/doc/html/rfc7518#section-3.1">siehe RFC7518 - &quot;alg&quot; (Algorithm) Header Parameter Values for JWS</a>. Weitere Signaturalgorithmen können unterstützt werden.</p>
</li>
<li><p>Der JSON Web Key muss mindestens folgende Parameter enthalten:</p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7517#section-4.1">&quot;kty&quot; (Key Type) Parameter</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7517#section-4.5">&quot;kid&quot; (Key ID) Parameter</a></li>
<li>Für einen öffentlichen RSA Web Key: &quot;n&quot; (Modulus) Parameter, &quot;e&quot; (Exponent) Parameter (Siehe <a href="https://datatracker.ietf.org/doc/html/rfc7518#section-6.3">RFC7518 - 6.3 Parameters for RSA Keys</a>)</li>
<li>Für einen öffentlichen Elliptic Curve Web Key: &quot;crv&quot; (Curve) Parameter, &quot;x&quot; (X Coordinate) Parameter, &quot;y&quot; (Y Coordinate) Parameter (Siehe <a href="https://datatracker.ietf.org/doc/html/rfc7518#section-6.2">RFC7518 - 6.2 Parameters for RSA Keys</a>)</li>
</ul>
</li>
</ul>
<ol start="2">
<li>Ein Austausch des JSON Web Key muss durch eine der nachfolgenden Optionen implementiert werden. Option 1) wird aufgrund der in <a href="https://hl7.org/fhir/smart-app-launch/STU2/client-confidential-asymmetric.html#client-authentication-asymmetric-public-key">SMART App Launch - 5 - Client Authentication: Asymmetric (public key)</a> aufgeführten Vorteile empfohlen.</li>
</ol>
<p>(1) Austausch einer TLS-abgesicherten URL über die das oben genannte JSON Web Key Set abgerufen werden kann. Der Autorisierungsserver soll prüfen, dass diese URL mit dem <a href="https://datatracker.ietf.org/doc/html/rfc7515#section-4.1.2">&quot;jku&quot; Parameter</a> der Signatur des für die Authentifizierung des Clients verwendeten JSON Web Token übereinstimmt.</p>
<p>(2) Das JSON Web Key Set kann dem Autorisierungsserver direkt mitgeteilt werden. In diesem Fall soll das JSON Web Key Set mindestens zwei Schlüssel enthalten, sodass eine unterbrechungsfreie Schlüsselrotation durchgeführt werden kann. Nachteile dieser Option sind in <a href="https://hl7.org/fhir/smart-app-launch/STU2/client-confidential-asymmetric.html#registering-a-client-communicting-public-keys">SMART App Launch - 5.0.4 - Registering a SMART Backend Service (communicating public keys)</a> zusammengefasst.</p>
<p>Die verwendeten JSON Web Keys sollen regelmäßig gewechselt werden, um einem Schlüsselmissbrauch vorzubeugen.</p>
<ol start="3">
<li>Der Client erzeugt ein JSON Web Token entsprechend der in <a href="https://hl7.org/fhir/smart-app-launch/STU2/client-confidential-asymmetric.html#authenticating-to-the-token-endpoint">SMART App Launch - 5.0.5 - Authenticating to the Token endpoint</a> definierten Vorgaben und verwendet dies als &quot;client_assertion&quot;.</li>
</ol>
<h3 id="http-basic-authentication">HTTP Basic Authentication:</h3>
<p>Der Client tauscht während der Registrierung (siehe <div class='error'>Command 'pagelink' could not render: Page not found.</div>) ein Client Secret mit dem EHR aus. Eine Authentifizierung des Clients erfolgt per <a href="https://datatracker.ietf.org/doc/html/rfc7617">RFC7617 - The 'Basic' HTTP Authentication Scheme</a>. Als &quot;username&quot; muss die Client Id verwendet werden. Als Passwort muss das vorher ausgetauschte Client Secret verwendet werden.</p>
<hr />
<h2 id="austausch-des-autorisierungscodes-fur-ein-zugangstoken">Austausch des Autorisierungscodes für ein Zugangstoken</h2>
<p>In Abschnitt <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#obtain-access-token">SMART App Launch - 2.0.10 - Obtain access token</a> werden alle notwendigen Parameter definiert, durch die der Client mittels einer HTTP POST Anfrage (application/x-www-form-urlencoded kodiert) am token-Endpunkt des Autorisierungsservers ein Zugangstoken erhalten kann. Zu beachten ist, dass neben den in der Kernspezifikation gekennzeichneten Pflichtparametern, die Parameter &quot;id_token&quot; und &quot;refresh_token&quot; unterstützt werden MÜSSEN. Ein id_token muss ausgestellt werden, wenn der Client einen &quot;openid fhirUser&quot; Scope anfragt. Durch den Client angefragte Launch Context Claims müssen zurückgegeben werden. Eine Ausnahme ergibt sich durch den Fall, dass der Kontext im EHR nicht vorliegt (z.B. es besteht kein Fall/Patientenkontext).</p>
<p>Alle verpflichtenden Implementierungsdetails aus <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#obtain-access-token">SMART App Launch - 2.0.10 - Obtain access token</a> müssen durch den Autorisierungsserver unterstützt werden.</p>
<p>Es sei explizit darauf hingewiesen, dass sowohl die SMART App Launch Spezifikation, als auch der vorliegende Implementierungsleitfaden keine Vorgaben bezüglich der Struktur oder des Inhalts des Zugangstokens enthalten. Die Verwendung eines Referenztokens wird empfohlen, um einen Token Revocation Mechanismus effizient implementieren zu können. Siehe <a href="ImplementationGuide-markdown-Schritt6RefreshToken.html" title='ImplementationGuide/markdown/Schritt6RefreshToken.md'>Schritt 6</a>.</p>
<hr />
<h2 id="beispiel">Beispiel</h2>
<ol>
<li>Generierung Public/Private Key:</li>
</ol>
<div class="lang-json editor-colors"><div style="color:Black;background-color:White;"><pre>
{
    <span style="color:#A31515;">&quot;p&quot;</span>: <span style="color:#A31515;">&quot;xmB9u3-YZG9wQudAA0lrSxfPMrzdyRg9_ucaXVVXmBfEkP4B0TJf4Qy3PElekRpRwQQzkTGru06uJZr3C-FnnjbVyzGjSJovWP5S4vBm7zWVGMMhdLDCRtGqx2qC0MGLV7aAGg7XN590US_8XRqtMiMv4RHwj5mzMK-S-4-G_dc&quot;</span>,
    <span style="color:#A31515;">&quot;kty&quot;</span>: <span style="color:#A31515;">&quot;RSA&quot;</span>,
    <span style="color:#A31515;">&quot;q&quot;</span>: <span style="color:#A31515;">&quot;vrKETfeUnSZY7eMy0E1UfY8wwE0tFC5r63hpXMqvBKKORXd4XOdqVPUoGeWg-tk4g7aQWW5SJIYk72EGaRuZ-S1giFo724fbJ0lxMxM-HOqMrxhCEDFNOzsjS-tZzbq8krXOp8yAPMENx3bvMFyk2N84qFVaD4gkibIPR6QM_fM&quot;</span>,
    <span style="color:#A31515;">&quot;d&quot;</span>: <span style="color:#A31515;">&quot;iuoCvT6rbu0ME2V61cw9OSxafD6Fbk2rL4IwkS2AfiMnoEeHpII36oHjU-OYRCRtOGoj8Hes0NkBTffXocYbyXKAxpdzogh1WqPyCraIDJSNR_Wv2ebHdtmie_3ZOdPntYN6MN8y7rinlZBWNgXH8d7GCo48UnT4zu66gyqN7gWVN90it4B0Xcy_3RdHpIO3e1ES-zDWDkP8APL8NPxMAqX7NL5sYtWxKCdFXfMi456iZ_THMu4dJC9QtqTkzphwtsbSrGTTMZXHuqw92fH7NRRhc17vyanNzMXbPJ6Wiy8DoI_1Gopz9HFOWzK7RiQeJtes136vTRXKa3vcnZFB4Q&quot;</span>,
    <span style="color:#A31515;">&quot;e&quot;</span>: <span style="color:#A31515;">&quot;AQAB&quot;</span>,
    <span style="color:#A31515;">&quot;use&quot;</span>: <span style="color:#A31515;">&quot;sig&quot;</span>,
    <span style="color:#A31515;">&quot;kid&quot;</span>: <span style="color:#A31515;">&quot;t0xPKRRKap5FF6TItqt-ANoiSysWce7vAGL8vCXRBXQ&quot;</span>,
    <span style="color:#A31515;">&quot;qi&quot;</span>: <span style="color:#A31515;">&quot;cl61xViRvryTB6ZpIlxd_4Iqj7P27TUVg5foJ3OfzoqwMdCHzxqdmUkc5_hvZB18eUTxu6hj1f4tw63r61D84SdOxJ8YC7b7Cu1sc2sh4YvlrpeGjKFZfHQCCxQigXJID4XBElxxqoiTWnCrUQPq6cMo3An9h-_w0AjtJAA2i2Y&quot;</span>,
    <span style="color:#A31515;">&quot;dp&quot;</span>: <span style="color:#A31515;">&quot;dNWDd5hQYmaXkW-s7cKh5Fojd9hwLu2OJcBqcKnAqxzkchiHbXPjsCHTETiM75y2pZ0Z2duNLwXJ3vADrAWXB0F4bPHRHwNf-2Pd4TaBCUVfiHP0EkvAQAFgOY5reRNkQ8aCb9ZpvqK02NQQJ618b9j1a_Mq4Qg-1t-xC2Oet4U&quot;</span>,
    <span style="color:#A31515;">&quot;alg&quot;</span>: <span style="color:#A31515;">&quot;RS384&quot;</span>,
    <span style="color:#A31515;">&quot;dq&quot;</span>: <span style="color:#A31515;">&quot;i-nGkL3Z2ANOtBtCKPrTxtvMVQtKy8fTfox2IZLEHo51_BnPwbo4leTZa0bDecjuYhUMi9EZi5qwdsGlRnDt45ibfu9Vg5iF_qkv2N2BcQ3V8pHFxsOlepPFLeqblQoxWSLzYMH2RJ0QUwy8KauPd18v3rHgxgyJYk22UEXZEmk&quot;</span>,
    <span style="color:#A31515;">&quot;n&quot;</span>: <span style="color:#A31515;">&quot;k8Xy7sDGlI_8R1hAVnWw1skyzANUyctiJzcVQYNIBKtJ-otzokwcPhI1Nj9HEjyBw-2ikPw7eQ9VbcVzOZmJY57XcuMFl0UkR8acGdTt5VNQMxKdbzk3RbbFv9fuadT9nMjZfXZ1Z1UX9dxYt51T-Ay7Qpo0_cczxlKMBmdScZOiQCCyfUW4rVwDQZ5-Vnjk8AkmhChjidrsnu_aVj8P4A_g6Ik-XIyhGwFmXHFWyqAANgZdV-kypdaXwGjgrNBjw0AbDC90AghYhjY1nslWFgZIeI-DDqUyS6X8NX3CIPQsTs2iSXBQTeoOmSmLHAjC4rgiajtCM7cMdlY0SBRuFQ&quot;</span>
}

</pre></div>
</div>
<ol start="2">
<li>JSON Web Key Set mit öffenlichem Schlüsselteil erzeugen:</li>
</ol>
<div class="lang-json editor-colors"><div style="color:Black;background-color:White;"><pre>
{
    <span style="color:#A31515;">&quot;keys&quot;</span>: [
        {
            <span style="color:#A31515;">&quot;kty&quot;</span>: <span style="color:#A31515;">&quot;RSA&quot;</span>,
            <span style="color:#A31515;">&quot;e&quot;</span>: <span style="color:#A31515;">&quot;AQAB&quot;</span>,
            <span style="color:#A31515;">&quot;use&quot;</span>: <span style="color:#A31515;">&quot;sig&quot;</span>,
            <span style="color:#A31515;">&quot;kid&quot;</span>: <span style="color:#A31515;">&quot;t0xPKRRKap5FF6TItqt-ANoiSysWce7vAGL8vCXRBXQ&quot;</span>,
            <span style="color:#A31515;">&quot;alg&quot;</span>: <span style="color:#A31515;">&quot;RS384&quot;</span>,
            <span style="color:#A31515;">&quot;n&quot;</span>: <span style="color:#A31515;">&quot;k8Xy7sDGlI_8R1hAVnWw1skyzANUyctiJzcVQYNIBKtJ-otzokwcPhI1Nj9HEjyBw-2ikPw7eQ9VbcVzOZmJY57XcuMFl0UkR8acGdTt5VNQMxKdbzk3RbbFv9fuadT9nMjZfXZ1Z1UX9dxYt51T-Ay7Qpo0_cczxlKMBmdScZOiQCCyfUW4rVwDQZ5-Vnjk8AkmhChjidrsnu_aVj8P4A_g6Ik-XIyhGwFmXHFWyqAANgZdV-kypdaXwGjgrNBjw0AbDC90AghYhjY1nslWFgZIeI-DDqUyS6X8NX3CIPQsTs2iSXBQTeoOmSmLHAjC4rgiajtCM7cMdlY0SBRuFQ&quot;</span>
        }
    ]
}

</pre></div>
</div>
<ol start="3">
<li><p>Bereitstellung des JSON Web Key Sets unter einer ohne weitere Authtentifizierung erreichbare URL (https abgesichert) ODER Übermittelung des JSON Web Key Sets an den Autorisierungsserver (keine weiteren Vorgaben).</p>
</li>
<li><p>Erzeugung eines JSON Web Tokens signiert mit dem oben genannten Private/Public Key Pair:</p>
</li>
</ol>
<div class="lang-json editor-colors"><div style="color:Black;background-color:White;"><pre>
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzM4NCJ9.eyJpc3MiOiJFeGFtcGxlIElzc3VlciIsImlhdCI6bnVsbCwiZXhwIjoxNjQzOTg2OTcwLCJhdWQiOiJodHRwczovL2V4YW1wbGUub3JnL2F1dGgvdG9rZW4iLCJzdWIiOiJUZXN0Q2xpZW50SWQiLCJqdGkiOiI3NmE1ZTA4Ni1lOWE3LTQ0ZmUtOTcyOC03MTIxNjE1YzYyOTEifQ.i_Hzfzuqquc7ouj0-CDxtddvsLxTr5RmcR-hlXYRFmAvxaAg6akf_EL6DAqRVLfW1u-FU9JJs015eTvtugYNNI0QPWdZVHJQ54TVIkVx8jsaf_RvbF3q4DpeiRdEXv1j34k_KrgNRTi6d1Rneem8qmTKIQRiWv1iYeNgENPHnL0SV69Pi7PoXr2s7JWFUO56HqWR0tmPweVm3aS24jeAaRGqISAbTPHuq-R8QVD7fMFqQBR_n6xSMCHUxZHBQDFg2c6leY8WlrwZUz9lJZnX5R76iHylfqZ-kAk38xHpnFtsmbF8YH4EUjYmSGT8SPn0y9RHKFI7LCm9p5DeVPPgYQ

</pre></div>
</div>
<p>Dekodierte Form:</p>
<p>Header:</p>
<div class="lang-json editor-colors"><div style="color:Black;background-color:White;"><pre>
{
  <span style="color:#A31515;">&quot;typ&quot;</span>: <span style="color:#A31515;">&quot;JWT&quot;</span>,
  <span style="color:#A31515;">&quot;alg&quot;</span>: <span style="color:#A31515;">&quot;RS384&quot;</span>
}

</pre></div>
</div>
<p>Body:</p>
<div class="lang-json editor-colors"><div style="color:Black;background-color:White;"><pre>
{
  <span style="color:#A31515;">&quot;iss&quot;</span>: <span style="color:#A31515;">&quot;Example Issuer&quot;</span>,
  <span style="color:#A31515;">&quot;iat&quot;</span>: <span style="color:Blue;">null</span>,
  <span style="color:#A31515;">&quot;exp&quot;</span>: 1643986970,
  <span style="color:#A31515;">&quot;aud&quot;</span>: <span style="color:#A31515;">&quot;https://example.org/auth/token&quot;</span>,
  <span style="color:#A31515;">&quot;sub&quot;</span>: <span style="color:#A31515;">&quot;TestClientId&quot;</span>,
  <span style="color:#A31515;">&quot;jti&quot;</span>: <span style="color:#A31515;">&quot;76a5e086-e9a7-44fe-9728-7121615c6291&quot;</span>
}

</pre></div>
</div>
<ol start="5">
<li>Access Token abrufen</li>
</ol>
<pre><code>POST /token HTTP/1.1
Host: server.example.com
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&amp;
code=&lt;Autorisierungscode aus Schritt 3&gt;&amp;
redirect_uri=https://example.org/redirect_uri/fhir/client/exampleId&amp;
code_verifier=2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b&amp;
client_id=TestClientId&amp;
client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer&amp;
client_assertion=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzM4NCJ9.eyJpc3MiOiJFeGFtcGxlIElzc3VlciIsImlhdCI6bnVsbCwiZXhwIjoxNjQzOTg2OTcwLCJhdWQiOiJodHRwczovL2V4YW1wbGUub3JnL2F1dGgvdG9rZW4iLCJzdWIiOiJUZXN0Q2xpZW50SWQiLCJqdGkiOiI3NmE1ZTA4Ni1lOWE3LTQ0ZmUtOTcyOC03MTIxNjE1YzYyOTEifQ.i_Hzfzuqquc7ouj0-CDxtddvsLxTr5RmcR-hlXYRFmAvxaAg6akf_EL6DAqRVLfW1u-FU9JJs015eTvtugYNNI0QPWdZVHJQ54TVIkVx8jsaf_RvbF3q4DpeiRdEXv1j34k_KrgNRTi6d1Rneem8qmTKIQRiWv1iYeNgENPHnL0SV69Pi7PoXr2s7JWFUO56HqWR0tmPweVm3aS24jeAaRGqISAbTPHuq-R8QVD7fMFqQBR_n6xSMCHUxZHBQDFg2c6leY8WlrwZUz9lJZnX5R76iHylfqZ-kAk38xHpnFtsmbF8YH4EUjYmSGT8SPn0y9RHKFI7LCm9p5DeVPPgYQ

</code></pre>

                        </div>
                        <div id="ImplementationGuide-markdown-Schritt5FHIRRestInteraktion">
                            <h1 id="schritt-5-fhir-restful-interaktion">Schritt 5: FHIR Restful Interaktion</h1>
<hr />
<h3 id="informativ">Informativ</h3>
<hr />
<p>Das erhaltene Access Token kann durch den Client am FHIR-Endpunkt des EHR oder eines Ressourcenservers eingelöst werden. Hierzu ist bei jeder RESTful Interaktion ein Authorization-Header mitzusenden. Das Token ist per <a href="https://datatracker.ietf.org/doc/html/rfc6750">RFC6750 -  The OAuth 2.0 Authorization Framework: Bearer Token Usage</a> zu kodieren.</p>
<p>Bei der Verarbeitung des Access Token sind die Anforderungen nach <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#access-fhir-api">SMART App Launch - 2.0.11 - Access FHIR API</a> zu berücksichtigen. Unter anderem MÜSSEN folgende Validierungsschritte durchgeführt werden:</p>
<ul>
<li>Validierung, ob das Token abgelaufen ist oder zurückgezogen wurde.</li>
<li>Validierung, ob der &quot;aud&quot;-Parameter des Tokens mit dem angefragten Endpunkt übereinstimmt.</li>
<li>Validierung, ob alle angefragten RESTful-Interaktionen durch die Scopes innerhalb des Tokens abgedeckt sind.</li>
</ul>
<hr />
<h2 id="beispiel">Beispiel</h2>
<pre><code>GET /fhir/Patient
Accept: application/fhir+json;fhirVersion=4.0
Host: server.example.com
Bearer: &lt;Token aus Antwort von Schritt 4&gt;
</code></pre>

                        </div>
                        <div id="ImplementationGuide-markdown-Schritt6RefreshToken">
                            <h1 id="schritt-6-refresh-token-revocation">Schritt 6: Refresh Token &amp; Revocation</h1>
<hr />
<h3 id="informativ">Informativ</h3>
<hr />
<h2 id="refresh-tokens">Refresh Tokens</h2>
<p>Die Gültigkeitsdauer eines Access-Tokens kann beliebig durch das bestätigungsrelevante System gewählt werden. Mit Hinblick auf <a href="https://datatracker.ietf.org/doc/html/rfc6819#section-3.1.2">RFC6819 - OAuth 2.0 Threat Model and Security Considerations - Limited Access Token Lifetime</a> soll die Gültigkeitsdauer auf Minuten oder Stunden beschränkt werden. Das Gültigkeitsdatum wird im Access Token durch den Parameter &quot;expires_in&quot; angegeben. Alternativ kann die Gültigkeit des Tokens über den Introspection-Endpunkt abgefragt werden.</p>
<p>Um eine häufige Authentifizierung der Benutzer und/oder des Clients zu vermeiden, soll der Autorisierungsserver die Ausstellung von Refresh Tokens unterstützen.</p>
<p>Folgende Anforderungen aus <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#refresh-access-token">SMART App Launch - 2.0.12 - Refresh access token</a> sind bei der Unterstützung eines Token Refresh zu beachten:</p>
<ul>
<li>Der &quot;offline_access&quot; Scope muss unterstützt werden, der &quot;online_access&quot; Scope soll unterstützt werden.</li>
<li>Ein Refresh Token muss an die anfordernde Client Id gebunden werden, d.h. eine abweichende Client Id (übermittelt durch die Autorisierung des Clients) DARF NICHT verwendbar sein, um ein neues Access Token auszustellen.</li>
<li>Der Autorisierungsserver muss bei der Ausstellung eines neuen Access Tokens sicherstellen, dass im Vergleich zum originalen Access Token nur ein Subset oder die gleiche Menge an Scopes erlaubt werden. Fordert der Client neue Scopes an, soll das System die Menge aller Scopes auf die zuvor erlaubten Scopes einschränken.</li>
<li>Der Launch Context muss zurückgegeben werden, falls die entsprechenden Scopes durch den Client oder im originalen Access Token angefordert wurden.</li>
</ul>
<p>Alle verpflichtenden Implementierungsdetails aus <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#refresh-access-token">SMART App Launch - 2.0.12 - Refresh access token</a> müssen bei der Umsetzung eines Token Refresh durch den Autorisierungsserver unterstützt werden.</p>
<hr />
<h3 id="beispiel">Beispiel</h3>
<h2 id="token-revocation">Token Revocation</h2>
<p>Ein Access-Token MUSS zu einem beliebigen Zeitpunkt durch einen beliebigen Client per <a href="https://datatracker.ietf.org/doc/html/rfc7009">RFC7009 - OAuth 2.0 Token Revocation</a> zurückgezogen werden können.
Es muss sichergestellt werden, dass kein zeitlicher Verzug zwischen der Bestätigung, der zuvorgenannten Anfrage und der Invalidierung des Tokens herrscht, d.h nach einer Revocation-Anfrage muss sichergestellt werden, dass Anfragen beim Ressourcen-Server mit einem entsprechenden Token zurückgewiesen werden. Hierzu wird die Verwendung eines Introspection-Endpunktes nach <a href="https://datatracker.ietf.org/doc/html/rfc7662">RFC7662 - OAuth 2.0 Token Introspection</a> empfohlen.</p>
<hr />
<h3 id="beispiel-1">Beispiel`</h3>
<pre><code>GET /fhir/Patient
Content-Type: application/x-www-form-urlencoded
Host: server.example.com

grant_type=refresh_token&amp;
refresh_token=&lt;Refresh Token aus Schritt 4&gt;&amp;
scope=&lt;Scopes aus Schritt 2&gt;
</code></pre>

                        </div>

            </div>

        </div>
    </div>

                    </div>

                </div>

            </div>

            <div class="ig-view-footer" role="contentinfo" aria-label="Footer">
                
<div class="container">
    <div class="row">
        <p>Powered by <b>SIMPLIFIER.NET</b></p>
        <div>
            HL7<sup>&reg;</sup> and FHIR<sup>&reg;</sup> are the registered trademarks of Health Level Seven International
        </div>
    </div>
</div>

            </div>

        </div>

    </body>

</html>