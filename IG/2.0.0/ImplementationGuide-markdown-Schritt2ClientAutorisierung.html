
<!DOCTYPE html>
<html lang="en">

    <head>

        <meta charset="utf-8" />
        <title>Implementierungsleitfaden ISiK-Sicherheit - Rechtedelegation und Client-Authentifizierung</title>

        <link rel="icon" href="static/styles/common/favicon.ico" />

        <script src="static/styles/common/jquery/jquery.min.js"></script>
        <script src="static/styles/common/bootstrap/bootstrap.min.js"></script>

        <link rel="stylesheet" href="static/styles/common/main.min.css" />
        <link rel="stylesheet" href="static/styles/common/bootstrap/bootstrap.min.css" />
        <link rel="stylesheet" href="static/styles/common/rendering/rendering.min.css" />

        <script src="static/styles/common/rendering/stu3TreeTable.min.js"></script>
        <script src="static/styles/common/rendering/baseTreetable.min.js"></script>

        <link rel="stylesheet" href="static/project/ImplementationGuide/style/style.css?v=1d9469390588b00" />

    </head>

    <body>

        <div id="ig-viewer">

            <div class="ig-view-content">

                <div id="ig-view-twolevelmenu">

                    <div class="header" role="banner" aria-label="Header">
                        


<nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="ImplementationGuide-markdown-Einfuehrung.html">
                Implementierungsleitfaden ISiK-Sicherheit - Rechtedelegation und Client-Authentifizierung
            </a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">


                    <li>
                        <a href="ImplementationGuide-markdown-Einfuehrung.html">
                            Einf&#xFC;hrung
                        </a>
                    </li>

                        <li>
                            <a href="ImplementationGuide-markdown-ReleaseMatrix.html">
                                Release Matrix
                            </a>
                        </li>
                        <li>
                            <a href="ImplementationGuide-markdown-Motivation.html">
                                Motivation
                            </a>
                        </li>
                        <li class="dropdown">

                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                &#xDC;bergreifende Festlegungen <span class="caret"></span>
                            </a>

                            <ul class="dropdown-menu">

                                    <li>
                                        <a href="ImplementationGuide-markdown-UebergreifendeFestlegungen.html">
                                            &#xDC;bergreifende Festlegungen
                                        </a>
                                    </li>
                                    <li role="separator" class="divider"></li>

                                    <li>
                                        <a href="ImplementationGuide-markdown-Methodik.html">
                                            Methodik
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-BestaetigungsrelevanteSysteme.html">
                                            Best&#xE4;tigungsrelevante Systeme
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-KompatibilitaetDerGematikSpezifikation.html">
                                            Kompatibilit&#xE4;t der gematik-Spezifikation
                                        </a>
                                    </li>

                            </ul>
                        </li>
                        <li class="dropdown">

                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                Smart App Launch <span class="caret"></span>
                            </a>

                            <ul class="dropdown-menu">

                                    <li>
                                        <a href="ImplementationGuide-markdown-SmartAppLaunch.html">
                                            Smart App Launch
                                        </a>
                                    </li>
                                    <li role="separator" class="divider"></li>

                                    <li>
                                        <a href="ImplementationGuide-markdown-Schritt1RegistierungClient.html">
                                            Schritt 1 - Registrierung Client
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-Schritt2ClientAutorisierung.html">
                                            Schritt 2 - Client Autorisierung
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-Schritt3EvaluierungAutorisierungsanfrage.html">
                                            Schritt 3 - Evaluierung Autorisierungsanfrage
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-Schritt4AustauschAutorisierungscodesZugangstoken.html">
                                            Schritt 4 - Austausch - Autorisierungscodes Zugangstoken
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-Schritt5FhirRestInteraktion.html">
                                            Schritt 5 - FHIR Restful Interaktion
                                        </a>
                                    </li>
                                    <li>
                                        <a href="ImplementationGuide-markdown-Schritt6RefreshToken.html">
                                            Schritt 6 - Refresh Token &amp; Revocation
                                        </a>
                                    </li>

                            </ul>
                        </li>
                        <li>
                            <a href="ImplementationGuide-markdown-ScopesAndLaunchContext.html">
                                Scopes &amp; Launch Context
                            </a>
                        </li>
                        <li>
                            <a href="ImplementationGuide-markdown-Conformance.html">
                                Conformance
                            </a>
                        </li>

            </ul>
        </div>
    </div>
</nav>

                    </div>

                    <div class="content container" role="main" aria-label="Main content">
                        

    <div class="row">


        <div class="col-md-24">

            <div id="preview-content">

                <h1 id="schritt-2-app-bittet-um-autorisierung">Schritt 2: App bittet um Autorisierung</h1>
<p>Im nachfolgenden Schritt wird durch den Client an dem &quot;authorize&quot;-Endpunkt des Autorisierungsservers ein Autorisierungscode angefragt, welcher innerhalb eines Authorization Code Flows (vgl. <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-4.1">RFC6749</a>) durch ein OAuth 2.0 Access Token ersetzt werden kann.</p>
<p>Abhängig davon, ob der Client durch einen EHR Launch oder Standalone Launch gestartet wird, existieren unterschiedliche Schritte für die Anfrage eines Autorisierungscodes.</p>
<hr />
<h2 id="ehr-launch">EHR Launch</h2>
<p>Das bestätigungsrelevante System MUSS in der Lage sein, den Client durch einen externen Kontextaufruf zu starten. Im Kontext der derzeitig eingeloggten Benutzer:in wird der Client gestartet, vgl. <a href="ImplementationGuide-markdown-SmartAppLaunch.html" title='ImplementationGuide/markdown/SmartAppLaunch.md'>EHR Launch / Standalone Launch</a>. Der Aufruf des Clients MUSS alle in <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#step-2-launch-ehr">SMART App Launch - 2.0.7 - Launch App: EHR Launch</a> dokumentierten Parameter enthalten.</p>
<p>Es sei darauf hingewiesen, dass jeder EHR Launch mit einem eindeutigen Launch Parameter zu assoziieren ist. Mit diesem beliebig gewählten Parameter (z.B. eine UUID) kann der Client das Access Token mit dem Kontext, aus dem der Client gestartet worden ist, verknüpfen. Der Kontext kann beispielsweise Informationen zum Patienten oder Kontakt/Fall enthalten, welcher dem Anwender zuvor präsentiert wurde. Dieser Kontext wird dem Client durch sogenannte <a href="https://hl7.org/fhir/smart-app-launch/STU2/scopes-and-launch-context.html#scopes-for-requesting-context-data">Launch Context Claims</a> vermittelt. Diese Claims enthalten IDs der FHIR-Ressourcen, welche die zuvor genannten Datenobjekte repräsentieren. Es ist notwendig innerhalb der SMART authorization sequence die angeforderten <a href="https://hl7.org/fhir/smart-app-launch/STU2/scopes-and-launch-context.html#scopes-for-requesting-context-data">Launch Context Claims</a> an den Client zurückzugeben, vgl. Abschnitt <a href="ImplementationGuide-markdown-Schritt4AustauschAutorisierungscodesZugangstoken.html" title='ImplementationGuide/markdown/Schritt4AustauschAutorisierungscodesZugangstoken.md'>Austausch des Autorisierungscodes für ein Zugangstoken</a>. Der Client kann spezifische Kontextparameter anfragen. Sollten diese jedoch nicht verfügbar sein (z.B. der Client wurde ohne Patientenkontext aufgerufen), können die zurückgegebenen Launch Context Claims von den gewünschten Scopes abweichen.</p>
<hr />
<h2 id="standalone-launch-sequence">Standalone Launch Sequence</h2>
<p>Aufgrund des fehlenden Kontexts zwischen Client und dem bestätigungsrelevanten System, KANN der Client durch Angabe von gewünschten Smart Launch Scopes bestimmen, welche Details durch den Autorisierungsserver in der Access Token Response bereitgestellt werden MÜSSEN. Beispielsweise kann, äquivalent zum EHR Launch, der Patienten und/oder Kontakt/Fall Kontext angefordert werden. Genaue Details für die Syntax der Launch Context Scope finden sich im Kapitel <a href="ImplementationGuide-markdown-ScopesAndLaunchContext.html" title='ImplementationGuide/markdown/ScopesAndLaunchContext.md'>SMART on FHIR Launch Context Scope Syntax</a>.</p>
<hr />
<h2 id="parameter-autorisierungsanfrage">Parameter Autorisierungsanfrage</h2>
<p>Der Aufruf des Clients MUSS alle in <a href="https://hl7.org/fhir/smart-app-launch/STU2/app-launch.html#step-4-authorization-code">SMART App Launch - 2.0.9 - Obtain authorization code</a> dokumentierten Parameter enthalten. Insbesondere gilt dies für die Unterstützung von HTTP POST-basierten Autorisierungsanfragen und der Unterstützung von <a href="https://datatracker.ietf.org/doc/html/rfc7636">Proof Key for Code Exchange by OAuth Public Clients</a>.</p>
<p>Zu beachten ist, dass durch den SMART App Launch der &quot;state&quot;-Parameter abweichend von RFC6749 verpflichtend ist.</p>
<hr />
<h2 id="tls">TLS</h2>
<p>Alle Autorisierungsendpunkte MÜSSEN per HTTPS (TLS-Verschlüsselung) erreichbar sein. Im Echtbetrieb MUSS die Kommunikation ausschließlich per HTTPS erfolgen. Vorgaben zur einzusetzenden TLS Version, siehe <a href="https://simplifier.net/guide/implementierungsleitfadenisik-basismodul/I-markdown-UebergreifendeFestlegungen-UebergreifendeFestlegungen-Rest?version=current">Sicherheitsaspekte</a>.</p>
<hr />
<h2 id="abruf-smart-configuration">Abruf SMART Configuration</h2>
<p>Als Einstiegspunkt für einen Standalone Launch MUSS dem Client die Url des FHIR Endpunktes bekannt gegeben werden. Anschließend erfolgt eine Abfrage des &quot;.well-known/smart-configuration&quot; Dokumentes, welche durch den FHIR Endpunkt bereitgestellt werden MUSS. Vorgaben zum Format sind dem Abschnitt <a href="ImplementationGuide-markdown-Conformance.html" title='ImplementationGuide/markdown/Conformance.md'>Smart Configuration</a> zu entnehmen. Hierdurch erhält der Client dynamisch die Adresse des Autorisierungsservers inkl. &quot;authorize&quot; und &quot;token&quot; Endpunkt. Falls durch das bestätigungsrelevante System OAuth 2.0 Endpunkte optional über das CapabilityStatement des FHIR-Endpunktes zur Verfügung gestellt werden, MÜSSEN diese Inhalte identisch zu den Inhalten des &quot;.well-known/smart-configuration&quot; Dokumentes sein.</p>
<hr />
<h2 id="hinweise-zu-identity-scopes">Hinweise zu Identity Scopes</h2>
<p>Um Informationen über die authentifizierten Endbenutzer:in zu erhalten, kann ein Client per OpenID Connect ein Identitätstoken zusammen mit einem Zugangstoken anfragen. Hierzu sind in Kombination die Scopes &quot;openid&quot; und &quot;fhirUser&quot; zu verwenden. Zu bestätigende Systeme MÜSSEN die Vorgaben nach <a href="https://hl7.org/fhir/smart-app-launch/STU2/scopes-and-launch-context.html#scopes-for-requesting-identity-data">2.0.4 - Scopes for requesting identity data</a> umsetzen. Anstatt dem Claim &quot;fhirUser&quot; kann - aus Gründen der Rückwärtskompatibilität - auch der Claim &quot;profile&quot; verwendet werden. Die Unterstützung des &quot;profile&quot; claims ist optional. Die Vorgaben zur Umsetzung der OpenID Connect Core Spezifikation zur Erzeugung eines ID-Tokens sind bestätigungsrelevant.</p>
<hr />
<h2 id="hinweise-zu-access-scopes">Hinweise zu Access Scopes</h2>
<p>Innerhalb des Scope Parameters, welcher als Teil der Autorisierungsanfrage versendet wird, kann der Client dem Server mitteilen, welche Scopes zur korrekten Ausführung notwendig sind, d.h. welche FHIR-Restful Interaktionen vom Client benötigt werden. Diese Scopes repräsentieren die Menge aller Scopes, welche durch den Client gewünscht werden, jedoch nicht notwendigerweise durch den Server unterstüzt und/oder erlaubt werden. Es steht dem Autorisierungsserver frei diese Scopes einzuschränken, falls der Client für die Anforderung der Scopes nicht berechtigt ist. Weitere Details zur Syntax der Access Scopes siehe <a href="ImplementationGuide-markdown-ScopesAndLaunchContext.html" title='ImplementationGuide/markdown/ScopesAndLaunchContext.md'>SMART on FHIR Access Scope Syntax</a>.</p>
<p>Hieraus folgt, dass die angeforderten Scopes nur die Kategorien an Rechten repräsentieren, die an den anfragenden Client delegiert werden dürfen. Somit können generell bestimmte Rechte ausgeschlossen werden. Eine Anfrage an den FHIR-REST-API-Endpunkt kann jedoch trotz validem Token mit den spezifizierten Scopes abgelehnt werden, falls während der Evaluierung der Anfrage seitens des Servers festgestellt wird, dass der Benutzer die gewünschten Ressourcen nicht verarbeiten darf.</p>
<p>Der Autorisierungsserver MUSS eine Konfiguration der erlaubten Scopes pro Client unterstützen.</p>
<hr />
<h2 id="beispiel">Beispiel</h2>
<p>POST /authorize HTTP/1.1<br>
Content-Type: application/x-www-form-urlencoded<br>
Host: server.example.com</p>
<pre><code>response_type=code&amp;
client_id=TestClientId&amp;
redirect_uri=https://example.org/redirect_uri/fhir/client/exampleId&amp;
scope=user/*.rs openid fhirUser&amp;
state=df01f5f8-5bf2-45ea-ab7a-706361da0515&amp;
aud=http://example.org/fhir/&amp;
code_challenge=2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b&amp;
code_challenge_method=S256
</code></pre>



            </div>

        </div>
    </div>

                    </div>

                </div>

            </div>

            <div class="ig-view-footer" role="contentinfo" aria-label="Footer">
                
<div class="container">
    <div class="row">
        <p>Powered by <b>SIMPLIFIER.NET</b></p>
        <div>
            HL7<sup>&reg;</sup> and FHIR<sup>&reg;</sup> are the registered trademarks of Health Level Seven International
        </div>
    </div>
</div>

            </div>

        </div>

    </body>

</html>